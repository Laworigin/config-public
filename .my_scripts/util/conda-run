#!/usr/bin/env bash
#
# Much of the boilerplate below was generated by
# https://github.com/gqmelo/exec-wrappers

# See https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/
set -o errexit -o errtrace -o nounset -o pipefail

_CONDA_DIR="${HOME}/.local/pkg/conda"

_run_activate_scripts() {
  ACTIVATE_D="$1"
  if [[ -d ${ACTIVATE_D} ]]; then
    while IFS= read -r -d '' f; do
      # shellcheck disable=SC1090
      source "${f}"
    done < <(find "${ACTIVATE_D}" -name "*.sh")
  fi
}

main() {
  if [[ $# -le 1 ]]; then
    printf 'Usage: %s env-name command [args]' "$(basename "$0")"
    exit 1
  fi
  local conda_env="$1"
  export CONDA_PREFIX="${_CONDA_DIR}/envs/${conda_env}"
  export CONDA_DEFAULT_ENV="${conda_env}"
  export CONDA_ENV_PATH="${CONDA_PREFIX}"
  export CONDA_PATH_BACKUP="${PATH}"
  # shellcheck disable=SC2236
  if [[ -n ${PS1-} ]]; then
    export CONDA_PS1_BACKUP="${PS1}"
  fi

  export PATH="${CONDA_PREFIX}/bin:${PATH}"
  _run_activate_scripts "${CONDA_PREFIX}/etc/conda/activate.d"
  exec -- "${@:2}"
}

main "$@"
